pipelines:
  "cicdus_teamcity_agent_deploy":
    environment_variables:
      AWS_CRED_DIR: /var/go/.aws/
      CHEF_CONFIG_DIR: /etc/chef/
      CHEF_SECRET_FILE: dev_encrypted_data_bag_secret
      TF_ACTION: deploy
      TF_DESTROY_TARGETS: all
      TF_VARIABLE_FILE: us_cicd.tfvars
      TF_VARIABLE_PATH: ../../../terraform_environment/variables/
    secure_variables: # https://api.gocd.org/current/#encrypt-a-plain-text-value
      GO_AWS_ACCESS_KEY_ID: Xive1jvS6yEWkZxIbvfEM30k1WGKvTyK
      GO_AWS_SECRET_ACCESS_KEY: EiYBguOF/PHZC34qxczzGFTIhgdbpbK0CzbAEOh2ijx/cNwsvYJmhRPbjVrTlEdS
      SLACK_URL_SUFFIX: bGQzd0F8g7bN87sgMfGjcziigZLK0/DxLqBoVWRRFeFgqwDzZK9dcGaLMmMdjOh9
    group: teamcity
    label_template: "${COUNT}"
    locking: off
    materials:
      "teamcity":
        git: git@github.com:daptiv/teamcity.git
        branch: master
        destination: teamcity
      "terraform_environment":
        git: git@github.com:daptiv/terraform_environment.git
        branch: master
        destination: terraform_environment
    stages:
      - "Plan":
          clean_workspace: true
          jobs:
            "Execute":
              resources:
                - docker
              tasks:
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose pull"
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake validate'"
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake plan'"
                    on_cancel:
                      exec:
                        working_directory: teamcity/terraform/teamcity_agent
                        command: /bin/bash
                        arguments:
                          - -c
                          - "docker-compose run --rm terraform 'rake cleanup'"
      - "Deploy":
          approval: manual
          clean_workspace: true
          jobs:
            "Execute":
              resources:
                - docker
              tasks:
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose pull"
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake notify[\"started\"]'"
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake $TF_ACTION'"
                    on_cancel:
                      exec:
                        working_directory: teamcity/terraform/teamcity_agent
                        command: /bin/bash
                        arguments:
                          - -c
                          - "docker-compose run --rm terraform 'rake cleanup'"
                - exec:
                    run_if: failed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake notify[\"failed\"]'"
      - "Verify":
          clean_workspace: true
          jobs:
            "Execute":
              resources:
                - docker
              tasks:
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose pull"
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake verify'"
                - exec:
                    run_if: passed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake notify[\"passed\"]'"
                - exec:
                    run_if: failed
                    working_directory: teamcity/terraform/teamcity_agent
                    command: /bin/bash
                    arguments:
                      - -c
                      - "docker-compose run --rm terraform 'rake notify[\"failed\"]'"
